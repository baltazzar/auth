/**
 * Baltazzar Auth
 * Versão: 0.1.3
 * Módulo front-end de autenticação para aplicações web.
 * Autor: Victor Bastos
 */
define("views/login",["require","exports","module","marionette"],function(a,e,t){var s=a("marionette");t.exports=s.ItemView.extend({template:"auth/login.tpl",events:{"submit .auth-login-form":"doLogin"},initialize:function(a){this.model=new Backbone.Model(a)},doLogin:function(e){e.preventDefault();var t=this.$(".auth-username").val(),s=this.$(".auth-password").val(),n=this.$(".auth-message");a(["../auth"],function(a){a.doLogin(t,s,n)})}})}),this.Handlebars=this.Handlebars||{},this.Handlebars.templates=this.Handlebars.templates||{},Handlebars.registerPartial("auth/_loggedUser.tpl",Handlebars.template(function(a,e,t,s,n){this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,a.helpers),n=n||{};var r,l="",i="function",o=this.escapeExpression;return l+='<div class="pull-right">\r\n	<p class="navbar-text auth-logged-user">\r\n		',(r=t.loggedUser)?r=r.call(e,{hash:{},data:n}):(r=e&&e.loggedUser,r=typeof r===i?r.call(e,{hash:{},data:n}):r),l+=o(r)+'\r\n	</p>\r\n	<button class="btn btn-xs btn-warning auth-logout" style="margin-top:14px; margin-right:10px;">Sair</button>\r\n</div>\r\n'})),this.Handlebars.templates["auth/login.tpl"]=Handlebars.template(function(a,e,t,s,n){this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,a.helpers),n=n||{};var r,l="",i="function",o=this.escapeExpression;return l+='<div class="auth-block">\r\n	<div class="panel panel-default">\r\n		<div class="panel-heading">&nbsp;</div>\r\n		<div class="panel-body">\r\n			<form class="auth-login-form clearfix">\r\n				<div class="col-md-12 auth-sigla text-center">',(r=t.authAppSigla)?r=r.call(e,{hash:{},data:n}):(r=e&&e.authAppSigla,r=typeof r===i?r.call(e,{hash:{},data:n}):r),l+=o(r)+'</div>\r\n				<div class="col-md-12">\r\n					<div class="alert alert-danger auth-message hide"></div>\r\n				</div>\r\n				<div class="col-md-12">\r\n					<div class="form-group">\r\n						<label class="auth-username-label">',(r=t.authUsernameLabel)?r=r.call(e,{hash:{},data:n}):(r=e&&e.authUsernameLabel,r=typeof r===i?r.call(e,{hash:{},data:n}):r),l+=o(r)+':</label>\r\n						<input type="text" class="form-control input-sm auth-username">\r\n					</div>\r\n				</div>\r\n				<div class="col-md-12">\r\n					<div class="form-group">\r\n						<label class="auth-password-label">',(r=t.authPasswordLabel)?r=r.call(e,{hash:{},data:n}):(r=e&&e.authPasswordLabel,r=typeof r===i?r.call(e,{hash:{},data:n}):r),l+=o(r)+':</label>\r\n						<input type="password" class="form-control input-sm auth-password">\r\n					</div>\r\n				</div>\r\n				<div class="col-md-12">\r\n					<button class="btn btn-success btn-block pull-right auth-confirm">',(r=t.authConfirmLabel)?r=r.call(e,{hash:{},data:n}):(r=e&&e.authConfirmLabel,r=typeof r===i?r.call(e,{hash:{},data:n}):r),l+=o(r)+"</button>\r\n				</div>\r\n			</form>\r\n		</div>\r\n	</div>\r\n</div>"}),define("templates",function(){}),define("auth",["require","exports","module","marionette","./views/login","handlebars"],function(a,e,t){var s=a("marionette"),n=a("./views/login"),r=a("handlebars");a(["./templates"]),t.exports={init:function(a){this.paramUsername=a.paramUsername,this.paramPassword=a.paramPassword,this.usernameLabel=a.usernameLabel||"Usuário",this.passwordLabel=a.passwordLabel||"Senha",this.confirmLabel=a.confirmLabel||"Confirmar",this.loginUrl=a.loginUrl,this.logoutUrl=a.logoutUrl,this.loggedUserUrl=a.loggedUserUrl,this.loggedUserEl=a.loggedUserEl,this.appSigla=a.appSigla||"App",this.protectViews(),this.setLoggedUserEl()},showLoginView:function(){return new n({authAppSigla:this.appSigla,authUsernameLabel:this.usernameLabel,authPasswordLabel:this.passwordLabel,authConfirmLabel:this.confirmLabel})},protectViews:function(){var a=this;s.Region.prototype.open=function(e){var t=this;e.protected?a.isLogged(function(s){s.status?(t.$el.empty().append(e.el),a.setLoggedUserEl(s.data.nome)):Backbone.history.navigate("login",{trigger:!0})}):t.$el.empty().append(e.el)}},setLoggedUserEl:function(a){var e=r.partials["auth/_loggedUser.tpl"]({loggedUser:a});$(this.loggedUserEl).html(e),$(".auth-logout").on("click",function(){Backbone.history.navigate("logout",{trigger:!0})})},doLogin:function(a,e,t){var s={},n=this;s[this.paramUsername]=a,s[this.paramPassword]=e,$.ajax({method:"POST",url:n.loginUrl,async:!1,cache:!1,dataType:"JSON",data:s,success:function(a){a.status?Backbone.history.navigate("",{trigger:!0}):t.html(a.message).removeClass("hide").fadeIn().delay(3e3).fadeOut()}})},doLogout:function(){var a=this;$.ajax({url:a.logoutUrl,async:!1,cache:!1,dataType:"JSON",success:function(a){a.status&&Backbone.history.navigate("login",{trigger:!0})}})},isLogged:function(a){var e=this;$.ajax({url:e.loggedUserUrl,async:!1,cache:!1,dataType:"JSON",success:function(e){a(e)}})}}});